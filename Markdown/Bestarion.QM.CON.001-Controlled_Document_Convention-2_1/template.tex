\documentclass[11pt,a4paper]{article}

% =================================================================
% --- 1. CÁC GÓI CƠ BẢN & CẤU HÌNH TRANG ---
% =================================================================
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage[english]{babel}
\usepackage{fontspec}

% ... (Các lệnh usepackage khác)
\usepackage{color}
\usepackage{fancyvrb}
\usepackage{framed}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{calc}
\usepackage{array}
\usepackage{longtable}
\usepackage{booktabs}

% >>> THÊM ĐOẠN NÀY ĐỂ FIX LỖI SHADED <<<
$if(highlighting-macros)$
$highlighting-macros$
$endif$
% >>> KẾT THÚC ĐOẠN THÊM <<<


% Cấu hình Font chữ (Ưu tiên Arial, nếu không có thì dùng TeX Gyre Heros)
\IfFontExistsTF{Arial}{
    \setmainfont{Arial}
}{
    \setmainfont{TeX Gyre Heros}
}

% Xử lý khoảng cách đoạn văn
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Gói hỗ trợ logic (quan trọng cho việc xử lý Caption)
\usepackage{etoolbox}

% =================================================================
% --- 2. MÀU SẮC & HEADER / FOOTER ---
% =================================================================
\usepackage[table]{xcolor}
\usepackage{fancyhdr}

% Định nghĩa màu Cam thương hiệu
\definecolor{brandOrange}{RGB}{237, 125, 49}

% Cấu hình Header và Footer
\pagestyle{fancy}
\fancyhf{} 

% Header Trái: Lấy từ biến header_line hoặc Title
$if(header_line)$
    \fancyhead[L]{\textcolor{gray}{\small $header_line$}}
$else$
    \fancyhead[L]{\textcolor{gray}{\small $title$}}
$endif$

% Footer Phải: Số trang
\fancyfoot[R]{\thepage}

% Đường kẻ Header màu xám
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\headrule}{\hbox to\headwidth{\color{gray}\leaders\hrule height \headrulewidth\hfill}}

% =================================================================
% --- 3. CẤU HÌNH BẢNG (TABLE) ---
% =================================================================
\usepackage{array}
\usepackage{longtable}

% Cấu hình độ giãn dòng và khoảng cách
\renewcommand{\arraystretch}{1.3} 
\setlength{\extrarowheight}{2pt}

% Tự động căn giữa bảng Longtable
\setlength{\LTleft}{\fill}
\setlength{\LTright}{\fill}

% TỰ ĐỘNG TÔ MÀU CAM HÀNG ĐẦU TIÊN
% Định nghĩa lại lệnh \toprule của Pandoc
\providecommand{\toprule}{}
\renewcommand{\toprule}{
    \hline                      
    \rowcolor{brandOrange}      
}

% Định nghĩa các đường kẻ còn lại
\providecommand{\midrule}{}
\renewcommand{\midrule}{\hline}

\providecommand{\bottomrule}{}
\renewcommand{\bottomrule}{\hline}

\providecommand{\endhead}{}
\providecommand{\endfirsthead}{}

% =================================================================
% --- 4. CẤU HÌNH HÌNH ẢNH (FIGURE) ---
% =================================================================
\usepackage{graphicx}
\usepackage{float}

% Logic TỰ ĐỘNG THU NHỎ ẢNH (Auto-fit) nếu ảnh lớn hơn khổ giấy
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth, height=\maxheight, keepaspectratio}

% Ép hình ảnh luôn căn giữa (Centering)
\let\origfigure\figure
\let\endorigfigure\endfigure
\renewenvironment{figure}[1][H] {
    \origfigure[#1]
    \centering
} {
    \endorigfigure
}

% =================================================================
% --- 5. CẤU HÌNH CAPTION (CHÚ THÍCH) ---
% =================================================================
\usepackage{caption}

% Style chung cho cả Bảng và Hình: In đậm Label, Nội dung in nghiêng, nằm dưới
\captionsetup{
  labelfont={bf, color=black},
  textfont={it},
  labelsep=colon,
  skip=10pt,
  position=bottom 
}

% LOGIC ĐẶC BIỆT: ÉP CAPTION CỦA BẢNG LONGTABLE XUỐNG DƯỚI ĐÁY
% (Mặc định Pandoc để caption ở trên, code này dùng etoolbox để dời xuống dưới)
\newcommand{\globalTableCaption}{}

\AtBeginEnvironment{longtable}{
  \renewcommand{\globalTableCaption}{} 
  \let\OldCaption\caption 
  \renewcommand{\caption}[2][]{
     \renewcommand{\globalTableCaption}{##2}
     % Ghi nhận vào List of Tables
     \addcontentsline{lot}{table}{\numberline{\thetable}##2}
  }
}

\AtEndEnvironment{longtable}{
  \ifdefempty{\globalTableCaption}{}{
    \begin{center} 
       \captionof{table}{\globalTableCaption}
    \end{center}
  }
}

% =================================================================
% --- 5.1. BỔ SUNG FIX LỖI (CHÈN VÀO ĐÂY) ---
% =================================================================
% Fix lỗi: ! LaTeX Error: File 'tocloft.sty' not found.
% (Đã có \usepackage{tocloft} ở mục 6 rồi, nhưng cần chắc chắn các gói phụ trợ)
\usepackage{calc}  % Fix lỗi tính toán chiều rộng bảng

% Fix lỗi: ! LaTeX Error: No counter 'none' defined.
% Pandoc đôi khi sinh ra code tham chiếu đến counter 'none' khi xử lý bảng phức tạp
\newcounter{none}

% Định nghĩa các lệnh đặc biệt mà Pandoc có thể sinh ra nhưng template thiếu
\providecommand{\e}{}  % Fix lỗi \e (escape char)
\providecommand{\s}{\textbackslash s} % Fix lỗi \s (regex)
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Đảm bảo các gói bảng đã được nạp (Mục 3 bạn đã có longtable, array rồi)
\usepackage{booktabs} % Để vẽ đường kẻ bảng đẹp hơn (\toprule, \midrule...)
\providecommand{\pandocbounded}[1]{#1}


% =================================================================
% --- 6. CẤU HÌNH MỤC LỤC (TOC, LOT, LOF) ---
% =================================================================
\usepackage{tocloft}

% Ép trang mục lục phải hiện Header/Footer
\tocloftpagestyle{fancy} 

% --- A. MỤC LỤC CHÍNH (TABLE OF CONTENT) ---
\renewcommand{\cfttoctitlefont}{\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase}
\renewcommand{\cftsecfont}{\sffamily}
\renewcommand{\cftsubsecfont}{\sffamily}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

% --- B. MỤC LỤC BẢNG (LIST OF TABLES) ---
\renewcommand{\cftlottitlefont}{\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase}
\renewcommand{\cfttabfont}{\sffamily}
\renewcommand{\cfttabpagefont}{\sffamily}
\renewcommand{\cfttableader}{\cftdotfill{\cftdotsep}}

% --- C. MỤC LỤC HÌNH ẢNH (LIST OF FIGURES) ---
\renewcommand{\cftloftitlefont}{\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase}
\renewcommand{\cftfigfont}{\sffamily}
\renewcommand{\cftfigpagefont}{\sffamily}
\renewcommand{\cftfigleader}{\cftdotfill{\cftdotsep}}

% =================================================================
% --- 7. CÁC LỆNH CHÈN THỦ CÔNG (CUSTOM COMMANDS) ---
% =================================================================

% Lệnh tạo Tiêu đề giả (Dùng cho Document Control)
\newcommand{\customTitle}[1]{
    \par\noindent 
    {\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase{#1}}
    \vspace{0.5cm} 
    \par
}

% Lệnh chèn Mục Lục Chính
\newcommand{\insertTOC}{
    \newpage
    \renewcommand{\contentsname}{TABLE OF CONTENT} 
    \tableofcontents
    \newpage
}

% Lệnh chèn Danh Sách Bảng
\newcommand{\insertListTables}{
    \newpage
    \renewcommand{\listtablename}{INDEX OF TABLES} 
    \listoftables
    \newpage
}

% Lệnh chèn Danh Sách Hình Ảnh
\newcommand{\insertListFigures}{
    \newpage
    \renewcommand{\listfigurename}{INDEX OF FIGURES} 
    \listoffigures
    \newpage
}

% =================================================================
% --- 8. HYPERLINKS & METADATA ---
% =================================================================
\usepackage[unicode=true]{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,      
    urlcolor=blue,
    pdftitle={Controlled Document Convention},
    pdfpagemode=FullScreen,
}

% =================================================================
% --- 9. TRANG BÌA (TITLE PAGE) ---
% =================================================================
\renewcommand{\maketitle}{
    \begin{titlepage}
        \newgeometry{top=3cm, bottom=3cm, left=2.5cm, right=2.5cm}
        \centering
        \vspace*{1cm}
        % Logic chèn Logo
        \IfFileExists{logo.jpeg}{\includegraphics[width=4cm]{logo.jpeg}}{
            \IfFileExists{logo.png}{\includegraphics[width=4cm]{logo.png}}{
                \begin{center}\fbox{\parbox[c][2cm]{4cm}{\centering LOGO MISSING}}\end{center}
            }
        }
        \vspace{0.5cm} 
        
        % Tiêu đề chính
        {\color{brandOrange} \fontsize{30}{75}\selectfont $title$ \par}
        $if(subtitle)$ \vspace{1.3cm} {\fontsize{24}{28}\selectfont $subtitle$ \par} $endif$
        
        \vfill 
        \raggedright
        \renewcommand{\arraystretch}{1.5}
        
        % Bảng thông tin trang bìa
        \begin{tabular}{ll}
            \textbf{Security classification:} & $security$ \\
            \textbf{Document code:} & $doc_code$ \\
            \textbf{Last updated by:} & $updated_by$ \\
            \textbf{Effective date:} & $effective_date$ \\
            \textbf{Version:} & $version$ \\
            % Dùng detokenize để tránh lỗi ký tự đặc biệt trong ID
            \textbf{Template ID:} & \detokenize{$template_id$} \\
        \end{tabular}
        \restoregeometry
    \end{titlepage}
}

% =================================================================
% --- 10. NỘI DUNG CHÍNH ---
% =================================================================
\begin{document}
\maketitle 

$body$

\end{document}