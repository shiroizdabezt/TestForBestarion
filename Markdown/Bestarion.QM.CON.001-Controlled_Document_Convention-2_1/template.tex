\documentclass[11pt,a4paper]{article}

% --- CÁC GÓI CẦN THIẾT ---
\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage[table]{xcolor} 
\usepackage{graphicx}
\usepackage{array}
\usepackage{longtable}
\usepackage{fancyhdr}
\usepackage[english]{babel} 
\usepackage{fontspec}

% --- GÓI ĐỂ CAN THIỆP VÀO LOGIC CỦA PANDOC ---
\usepackage{etoolbox} 

% =================================================================
% --- CẤU HÌNH CAPTION (CHÚ THÍCH BẢNG) ---
% =================================================================
\usepackage{caption}

% 1. Cấu hình Style: In đậm Table X, Nội dung in nghiêng
\captionsetup[table]{
  labelfont={bf, color=black},
  textfont={it},
  labelsep=colon,
  skip=10pt,
  position=bottom 
}

% 2. [CHIÊU THỨC] CHUYỂN CAPTION TỪ ĐẦU XUỐNG CUỐI
\newcommand{\globalTableCaption}{}

\AtBeginEnvironment{longtable}{
  \renewcommand{\globalTableCaption}{} 
  \let\OldCaption\caption 
  \renewcommand{\caption}[2][]{
     \renewcommand{\globalTableCaption}{##2}
     % Lệnh quan trọng: Ghi nhận caption vào danh sách List of Tables
     \addcontentsline{lot}{table}{\numberline{\thetable}##2}
  }
}

\AtEndEnvironment{longtable}{
  \ifdefempty{\globalTableCaption}{}{
    \begin{center} 
       \captionof{table}{\globalTableCaption}
    \end{center}
  }
}

% 3. CĂN GIỮA BẢNG LONGTABLE
\setlength{\LTleft}{\fill}
\setlength{\LTright}{\fill}

% =================================================================
% --- CẤU HÌNH MỤC LỤC & DANH SÁCH BẢNG (TOC & LOT) ---
% =================================================================
\usepackage{tocloft}
\tocloftpagestyle{fancy} 

% --- 1. CẤU HÌNH TABLE OF CONTENT (MỤC LỤC CHÍNH) ---
\definecolor{brandOrange}{RGB}{237, 125, 49}
\renewcommand{\cfttoctitlefont}{\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase}
\renewcommand{\cftsecfont}{\sffamily}
\renewcommand{\cftsubsecfont}{\sffamily}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

% --- 2. [MỚI] CẤU HÌNH LIST OF TABLES (MỤC LỤC BẢNG) ---
% Định dạng tiêu đề "INDEX OF TABLES" giống hệt "TABLE OF CONTENT"
\renewcommand{\cftlottitlefont}{\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase}
% Định dạng font chữ cho các dòng trong danh sách bảng
\renewcommand{\cfttabfont}{\sffamily}
\renewcommand{\cfttabpagefont}{\sffamily}
\renewcommand{\cfttableader}{\cftdotfill{\cftdotsep}}


% SỬA LỖI HYPERTARGET
\usepackage[unicode=true]{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,      
    urlcolor=blue,
    pdftitle={Controlled Document Convention},
    pdfpagemode=FullScreen,
}

% --- CÁC CẤU HÌNH KHÁC ---
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\IfFontExistsTF{Arial}{
    \setmainfont{Arial}
}{
    \setmainfont{TeX Gyre Heros}
}

% =================================================================
% --- CẤU HÌNH BẢNG TỰ ĐỘNG TÔ MÀU CAM HÀNG ĐẦU TIÊN ---
% =================================================================

\renewcommand{\arraystretch}{1.3} 
\setlength{\extrarowheight}{2pt}

\providecommand{\toprule}{}
\renewcommand{\toprule}{
    \hline                      
    \rowcolor{brandOrange}      
}

\providecommand{\midrule}{}
\renewcommand{\midrule}{\hline}

\providecommand{\bottomrule}{}
\renewcommand{\bottomrule}{\hline}

\providecommand{\endhead}{}
\providecommand{\endfirsthead}{}

% =================================================================

% --- ĐỊNH NGHĨA CÁC LỆNH CHÈN THỦ CÔNG ---

% 1. Tiêu đề giả (cho Document Control)
\newcommand{\customTitle}[1]{
    \par\noindent 
    {\color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase{#1}}
    \vspace{0.5cm} 
    \par
}

% 2. Chèn Mục Lục Chính
\newcommand{\insertTOC}{
    \newpage
    \renewcommand{\contentsname}{TABLE OF CONTENT} 
    \tableofcontents
    \newpage
}

% 3. [MỚI] Chèn Danh Sách Bảng
\newcommand{\insertListTables}{
    \newpage
    \renewcommand{\listtablename}{INDEX OF TABLES} % Đổi tên thành INDEX OF TABLES
    \listoftables
    \newpage
}

% --- THIẾT KẾ TRANG BÌA ---
\renewcommand{\maketitle}{
    \begin{titlepage}
        \newgeometry{top=3cm, bottom=3cm, left=2.5cm, right=2.5cm}
        \centering
        \vspace*{1cm}
        \IfFileExists{logo.jpeg}{\includegraphics[width=4cm]{logo.jpeg}}{
            \IfFileExists{logo.png}{\includegraphics[width=4cm]{logo.png}}{
                \begin{center}\fbox{\parbox[c][2cm]{4cm}{\centering LOGO MISSING}}\end{center}
            }
        }
        \vspace{0.5cm} 
        {\color{brandOrange} \fontsize{30}{75}\selectfont $title$ \par}
        $if(subtitle)$ \vspace{1.3cm} {\fontsize{24}{28}\selectfont $subtitle$ \par} $endif$
        \vfill 
        \raggedright
        \renewcommand{\arraystretch}{1.5}
        \begin{tabular}{ll}
            \textbf{Security classification:} & $security$ \\
            \textbf{Document code:} & $doc_code$ \\
            \textbf{Last updated by:} & $updated_by$ \\
            \textbf{Effective date:} & $effective_date$ \\
            \textbf{Version:} & $version$ \\
            \textbf{Template ID:} & \detokenize{$template_id$} \\
        \end{tabular}
        \restoregeometry
    \end{titlepage}
}

% --- CẤU HÌNH HEADER VÀ FOOTER ---
\pagestyle{fancy}
\fancyhf{} 

$if(header_line)$
    \fancyhead[L]{\textcolor{gray}{\small $header_line$}}
$else$
    \fancyhead[L]{\textcolor{gray}{\small $title$}}
$endif$

\fancyfoot[R]{\thepage}

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\headrule}{\hbox to\headwidth{\color{gray}\leaders\hrule height \headrulewidth\hfill}}


% --- BẮT ĐẦU VĂN BẢN ---
\begin{document}
\maketitle 

$body$

\end{document}