\documentclass[10pt,a4paper]{article} 
% Lưu ý: Size chữ cơ bản (11pt) và khổ giấy (a4paper) nên chỉnh trực tiếp ở dòng trên.

% =================================================================
% --- 1. USER CONFIGURATION (CẤU HÌNH SIÊU THAM SỐ) ---
% =================================================================
% --- A. CẤU HÌNH LỀ TRANG (PAGE MARGINS) ---
% Đơn vị hỗ trợ: in (inch), cm, mm, pt.
\def\PageLeftMargin{0.59in}   % Lề trái
\def\PageRightMargin{0.59in}  % Lề phải (Nên bằng lề trái để căn giữa đẹp)
\def\PageTopMargin{0.3in}     % Lề trên
\def\PageBottomMargin{0.3in}  % Lề dưới

% --- B. CẤU HÌNH KÍCH THƯỚC & KHOẢNG CÁCH ---
\newlength{\NumberWidth}
\setlength{\NumberWidth}{1.25cm} % Độ rộng dành cho số thứ tự Heading (VD: 1.1.)

\newlength{\LogoWidth}
\setlength{\LogoWidth}{4cm}      % Độ rộng của Logo ở trang bìa

\def\GlobalParSkip{6pt}          % Khoảng cách giữa các đoạn văn

% --- C. CẤU HÌNH MÀU SẮC (RGB) ---
\def\BrandColorRGB{237, 125, 49} % Màu chủ đạo (Cam)
\def\TableHeadColor{brandOrange} % Màu nền tiêu đề bảng (tham chiếu tên màu đã tạo)

% --- D. CẤU HÌNH FONT CHỮ ---
\def\PreferredFont{Arial}           
\def\FallbackFont{TeX Gyre Heros}   

% --- E. THÔNG TIN CHÂN TRANG (FOOTER INFO) ---
\def\CompanyCopyright{Bestarion} % Tên công ty ở Footer
\def\CopyrightYear{2025}         % Năm bản quyền


% =================================================================
% --- 2. PACKAGES & BASIC SETUP (KHÔNG CẦN CHỈNH SỬA TỪ ĐÂY) ---
% =================================================================
% Quan trọng: Nạp fancyhdr sớm để tránh lỗi undefined control sequence
\usepackage{fancyhdr} 
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{fontspec}
\usepackage{setspace}
\usepackage{calc}
\usepackage{etoolbox}
\usepackage[table]{xcolor} 


\usepackage{graphicx}
\makeatletter
\providecommand{\pandocbounded}[1]{#1}
\makeatother

% Áp dụng cấu hình margin
\usepackage[
  left=\PageLeftMargin,
  right=\PageRightMargin,
  top=\PageTopMargin, 
  bottom=\PageBottomMargin
]{geometry}

% Cấu hình Font
\IfFontExistsTF{\PreferredFont}{
    \setmainfont{\PreferredFont}
}{
    \setmainfont{\FallbackFont}
}

% Áp dụng khoảng cách đoạn
\setlength{\parindent}{0pt}   
\setlength{\parskip}{\GlobalParSkip}     

$if(highlighting-macros)$
$highlighting-macros$
$endif$

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% =================================================================
% --- 3. COLORS & GRAPHICS ---
% =================================================================
\usepackage{graphicx}
\usepackage{float}

% Định nghĩa màu từ tham số RGB
\definecolor{brandOrange}{RGB}{\BrandColorRGB}
\definecolor{mediumOrange}{RGB}{250, 206, 156} 
\definecolor{lightOrange}{RGB}{253, 226, 202} 

\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth, height=\maxheight, keepaspectratio}

% Fix hình ảnh căn giữa
\let\origfigure\figure
\let\endorigfigure\endfigure
\renewenvironment{figure}[1][H] {\origfigure[#1]\centering} {\endorigfigure}

% =================================================================
% --- 4. HEADER & FOOTER STYLING ---
% =================================================================
\pagestyle{fancy}
\fancyhf{} 

% Mở rộng Header sang trái
\fancyhfoffset[L]{\NumberWidth}

% Header
$if(header_line)$
    \fancyhead[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small $header_line$}\vspace{3pt}}
$else$
    \fancyhead[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small $title$}\vspace{3pt}}
$endif$

% Footer (Sử dụng biến tham số hóa)
\fancyfoot[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small Copyright \textcopyright\ \CopyrightYear, \CompanyCopyright.}}
\fancyfoot[R]{\fontfamily{ptm}\selectfont\thepage}

% Rules
\renewcommand{\headrulewidth}{0.4pt}
\setlength{\headheight}{15pt} 
\renewcommand{\headrule}{\hbox to\headwidth{\color{gray}\leaders\hrule height \headrulewidth\hfill}}
\renewcommand{\footrulewidth}{0pt} 

% =================================================================
% --- 5. HEADING STYLES ---
% =================================================================
\usepackage{titlesec}

\newcommand{\hangnum}[1]{\llap{\makebox[\NumberWidth][l]{#1}}}

\titlespacing*{\section}{0pt}{12pt}{6pt}
\titlespacing*{\subsection}{0pt}{10pt}{4pt}
\titlespacing*{\subsubsection}{0pt}{8pt}{3pt}

\titleformat{\section}[hang]
  {\color{brandOrange}\normalfont\Large\bfseries} 
  {\hangnum{\thesection.}} 
  {0pt} {}

\titleformat{\subsection}[hang]
  {\color{black}\normalfont\large\bfseries}
  {\hangnum{\thesubsection.}} 
  {0pt} {}

\titleformat{\subsubsection}[hang]
  {\color{black}\normalfont\normalsize\bfseries}
  {\hangnum{\thesubsubsection.}} 
  {0pt} {}

% =================================================================
% --- 6. LIST STYLES ---
% =================================================================
\usepackage{enumitem}
\usepackage{amssymb} 

\setlist{nosep, leftmargin=*} 
\setlist[itemize,1]{label=\raisebox{-0.9ex}{\textcolor{black}{\Huge\textbullet}}}
\setlist[itemize,2]{label=\textcolor{black}{\tiny$$\blacksquare$$}}
\setlist[itemize,3]{label=\textbullet}

% =================================================================
% --- 7. TABLES & CAPTIONS ---
% =================================================================
\usepackage{array}
\usepackage{longtable}
\usepackage{caption}

\captionsetup{
  labelfont={bf, color=black},
  textfont={it},
  labelsep=colon,
  skip=10pt,
  position=bottom 
}

\newcommand{\globalTableCaption}{}
\AtBeginEnvironment{longtable}{
  \renewcommand{\globalTableCaption}{} 
  \let\OldCaption\caption 
  \renewcommand{\caption}[2][]{
     \renewcommand{\globalTableCaption}{##2}
     \addcontentsline{lot}{table}{\numberline{\thetable}##2}
  }
}
\AtEndEnvironment{longtable}{
  \ifdefempty{\globalTableCaption}{}{
    \begin{center} \captionof{table}{\globalTableCaption} \end{center}
  }
}

% =================================================================
% --- 8. TOC & HYPERLINKS ---
% =================================================================
\usepackage{tocloft}
\usepackage[unicode=true]{hyperref}

\tocloftpagestyle{fancy} 

\renewcommand{\cfttoctitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}
\renewcommand{\cftlottitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}
\renewcommand{\cftloftitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}

\setlength{\cftsecindent}{-\NumberWidth}    
\setlength{\cftsubsecindent}{0pt}           
\setlength{\cftsubsubsecindent}{1.5em}      

\hypersetup{
    colorlinks=true, linkcolor=blue, filecolor=magenta, urlcolor=blue,
    pdftitle={Controlled Document Convention}, pdfpagemode=FullScreen,
}

\newcommand{\insertTOC}{\newpage \renewcommand{\contentsname}{TABLE OF CONTENT} \tableofcontents \newpage}
\newcommand{\insertListTables}{\newpage \renewcommand{\listtablename}{INDEX OF TABLES} \listoftables \newpage}
\newcommand{\insertListFigures}{\newpage \renewcommand{\listfigurename}{INDEX OF FIGURES} \listoffigures \newpage}

% =================================================================
% --- 9. TITLE PAGE (TRANG BÌA) --- [FIXED CENTER]
% =================================================================
\renewcommand{\maketitle}{
    \thispagestyle{empty}
    
    \begin{titlepage}
        % Cấu hình lề cho trang bìa (sử dụng cm cho chuẩn xác hoặc đổi sang inch tùy ý)
        \newgeometry{
            top=3cm, bottom=3cm, 
            left=2.5cm, right=2.5cm
        }
        
        \setlength{\parindent}{0pt}
        \centering 
        
        \vspace*{1cm}
        
        % Logo (Sử dụng biến LogoWidth)
        \IfFileExists{logo.jpeg}{\includegraphics[width=\LogoWidth]{logo.jpeg}}{
            \IfFileExists{logo.png}{\includegraphics[width=\LogoWidth]{logo.png}}{
                \begin{center}\fbox{\parbox[c][2cm]{4cm}{\centering LOGO MISSING}}\end{center}
            }
        }
        \vspace{0.5cm} 
        
        % Title
        {\color{brandOrange} \fontsize{30}{75}\selectfont $title$ \par}
        
        % Subtitle
        $if(subtitle)$ \vspace{1.3cm} {\fontsize{24}{28}\selectfont $subtitle$ \par} $endif$
        
        \vfill 
        
        % Metadata Table
        \begin{minipage}{0.8\textwidth} 
            \centering 
            \raggedright
            \renewcommand{\arraystretch}{1.5}
            \begin{tabular}{ll}
                \textbf{Security classification:} & \detokenize{$security$} \\
                \textbf{Document code:} & \detokenize{$doc_code$} \\
                \textbf{Last updated by:} & \detokenize{$updated_by$} \\
                \textbf{Effective date:} & \detokenize{$effective_date$} \\
                \textbf{Version:} & \detokenize{$version$} \\
                \textbf{Template ID:} & \detokenize{$template_id$} \\
            \end{tabular}
        \end{minipage}
        
        \restoregeometry
    \end{titlepage}
}

% =================================================================
% --- 10. DOCUMENT CONTENT --- 
% =================================================================
\onehalfspacing
\begin{document}

\maketitle 
\clearpage 

% --- Document Control Table ---
\noindent\hspace{-\NumberWidth}%
{\color{brandOrange}\fontsize{15}{18}\selectfont\bfseries DOCUMENT CONTROL}%
\par\vspace{6pt}

$if(changelog)$
\begin{longtable}{|p{0.09\textwidth}|p{0.22\textwidth}|p{0.14\textwidth}|p{0.12\textwidth}|p{0.16\textwidth}|p{0.12\textwidth}|}
    \hline
    \rowcolor{\TableHeadColor} % Sử dụng biến màu
    \textbf{Version} & \textbf{Change Description} & \textbf{Changed By} & \textbf{Date} & \textbf{Approved By} & \textbf{Date} \\
    \hline
    $for(changelog)$
    $changelog.version$ & $changelog.description$ & $changelog.changed_by$ & $changelog.changed_date$ & $changelog.approved$ & $changelog.approval_date$ \\ \hline
    $endfor$
\end{longtable}
$endif$
\clearpage 

% --- TOC ---
\insertTOC  
\insertListTables  
\insertListFigures

% Reset bộ đếm
\setcounter{table}{0}
\setcounter{figure}{0}

% --- Main Body ---
$body$

\end{document}
