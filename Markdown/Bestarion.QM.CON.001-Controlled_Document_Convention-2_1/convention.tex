\documentclass[11pt,a4paper]{article}

% =================================================================
% --- 1. USER CONFIGURATION (CẤU HÌNH SIÊU THAM SỐ) ---
% =================================================================
\def\PageLeftMargin{2.5cm}   % Lề trái (Rộng hơn để chứa số thứ tự)
\def\PageRightMargin{2.5cm}  % Lề phải (Cân bằng để fix lỗi căn giữa)
\def\PageTopMargin{1.5cm}    
\def\PageBottomMargin{1.5cm} 

\newlength{\NumberWidth}
\setlength{\NumberWidth}{1.25cm} 

\def\BrandColorRGB{237, 125, 49} 
\def\PreferredFont{Arial}           
\def\FallbackFont{TeX Gyre Heros}   

% =================================================================
% --- 2. PACKAGES & BASIC SETUP ---
% =================================================================
% Quan trọng: Nạp fancyhdr sớm để tránh lỗi undefined control sequence
\usepackage{fancyhdr} 
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{fontspec}
\usepackage{setspace}
\usepackage{calc}
\usepackage{etoolbox}
\usepackage[table]{xcolor} % Nạp xcolor với option table

\usepackage[
  left=\PageLeftMargin,
  right=\PageRightMargin,
  top=\PageTopMargin, 
  bottom=\PageBottomMargin
]{geometry}

\IfFontExistsTF{\PreferredFont}{
    \setmainfont{\PreferredFont}
}{
    \setmainfont{\FallbackFont}
}

\setlength{\parindent}{0pt}   
\setlength{\parskip}{6pt}     

$if(highlighting-macros)$
$highlighting-macros$
$endif$

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% =================================================================
% --- 3. COLORS & GRAPHICS ---
% =================================================================
\usepackage{graphicx}
\usepackage{float}

\definecolor{brandOrange}{RGB}{\BrandColorRGB}
\definecolor{mediumOrange}{RGB}{250, 206, 156} 
\definecolor{lightOrange}{RGB}{253, 226, 202} 

\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth, height=\maxheight, keepaspectratio}

% Fix hình ảnh căn giữa (Không cần dịch chuyển nữa vì lề trái phải đã bằng nhau 2.5cm)
\let\origfigure\figure
\let\endorigfigure\endfigure
\renewenvironment{figure}[1][H] {\origfigure[#1]\centering} {\endorigfigure}

% =================================================================
% --- 4. HEADER & FOOTER STYLING ---
% =================================================================
\pagestyle{fancy}
\fancyhf{} 

% Mở rộng Header sang trái
\fancyhfoffset[L]{\NumberWidth}

% Header
$if(header_line)$
    \fancyhead[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small $header_line$}\vspace{3pt}}
$else$
    \fancyhead[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small $title$}\vspace{3pt}}
$endif$

% Footer
\fancyfoot[L]{\fontfamily{ptm}\selectfont\textcolor{gray}{\small Copyright \textcopyright\ 2025, Bestarion.}}
\fancyfoot[R]{\fontfamily{ptm}\selectfont\thepage}

% Rules
\renewcommand{\headrulewidth}{0.4pt}
\setlength{\headheight}{15pt} 
\renewcommand{\headrule}{\hbox to\headwidth{\color{gray}\leaders\hrule height \headrulewidth\hfill}}

\renewcommand{\footrulewidth}{0pt} 

% =================================================================
% --- 5. HEADING STYLES ---
% =================================================================
\usepackage{titlesec}

\newcommand{\hangnum}[1]{\llap{\makebox[\NumberWidth][l]{#1}}}

\titlespacing*{\section}{0pt}{12pt}{6pt}
\titlespacing*{\subsection}{0pt}{10pt}{4pt}
\titlespacing*{\subsubsection}{0pt}{8pt}{3pt}

\titleformat{\section}[hang]
  {\color{brandOrange}\normalfont\Large\bfseries} 
  {\hangnum{\thesection.}} 
  {0pt} {}

\titleformat{\subsection}[hang]
  {\color{black}\normalfont\large\bfseries}
  {\hangnum{\thesubsection.}} 
  {0pt} {}

\titleformat{\subsubsection}[hang]
  {\color{black}\normalfont\normalsize\bfseries}
  {\hangnum{\thesubsubsection.}} 
  {0pt} {}

% =================================================================
% --- 6. LIST STYLES ---
% =================================================================
\usepackage{enumitem}
\usepackage{amssymb} 

\setlist{nosep, leftmargin=*} 
\setlist[itemize,1]{label=\raisebox{-0.9ex}{\textcolor{black}{\Huge\textbullet}}}
\setlist[itemize,2]{label=\textcolor{black}{\tiny$$\blacksquare$$}}
\setlist[itemize,3]{label=\textbullet}

% =================================================================
% --- 7. TABLES & CAPTIONS ---
% =================================================================
\usepackage{array}
\usepackage{longtable}
\usepackage{caption}

\captionsetup{
  labelfont={bf, color=black},
  textfont={it},
  labelsep=colon,
  skip=10pt,
  position=bottom 
}

\newcommand{\globalTableCaption}{}
\AtBeginEnvironment{longtable}{
  \renewcommand{\globalTableCaption}{} 
  \let\OldCaption\caption 
  \renewcommand{\caption}[2][]{
     \renewcommand{\globalTableCaption}{##2}
     \addcontentsline{lot}{table}{\numberline{\thetable}##2}
  }
}
\AtEndEnvironment{longtable}{
  \ifdefempty{\globalTableCaption}{}{
    \begin{center} \captionof{table}{\globalTableCaption} \end{center}
  }
}

% =================================================================
% --- 8. TOC & HYPERLINKS ---
% =================================================================
\usepackage{tocloft}
\usepackage[unicode=true]{hyperref}

\tocloftpagestyle{fancy} 

\renewcommand{\cfttoctitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}
\renewcommand{\cftlottitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}
\renewcommand{\cftloftitlefont}{%
    \hspace{-\NumberWidth}%
    \color{brandOrange}\Huge\bfseries\sffamily\MakeUppercase
}

\setlength{\cftsecindent}{-\NumberWidth}    
\setlength{\cftsubsecindent}{0pt}           
\setlength{\cftsubsubsecindent}{1.5em}      

\hypersetup{
    colorlinks=true, linkcolor=blue, filecolor=magenta, urlcolor=blue,
    pdftitle={Controlled Document Convention}, pdfpagemode=FullScreen,
}

\newcommand{\insertTOC}{\newpage \renewcommand{\contentsname}{TABLE OF CONTENT} \tableofcontents \newpage}
\newcommand{\insertListTables}{\newpage \renewcommand{\listtablename}{INDEX OF TABLES} \listoftables \newpage}
\newcommand{\insertListFigures}{\newpage \renewcommand{\listfigurename}{INDEX OF FIGURES} \listoffigures \newpage}


% =================================================================
% --- 9. TITLE PAGE (TRANG BÌA) --- [FIXED CENTER]
% =================================================================
\renewcommand{\maketitle}{
    \thispagestyle{empty}
    
    \begin{titlepage}
        % Cấu hình lề cho trang bìa
        \newgeometry{
            top=3cm, bottom=3cm, 
            left=2.5cm, right=2.5cm
        }
        
        % Đảm bảo không có thụt đầu dòng nào ảnh hưởng
        \setlength{\parindent}{0pt}
        \centering 
        
        \vspace*{1cm}
        
        % Logo
        \IfFileExists{logo.jpeg}{\includegraphics[width=4cm]{logo.jpeg}}{
            \IfFileExists{logo.png}{\includegraphics[width=4cm]{logo.png}}{
                \begin{center}\fbox{\parbox[c][2cm]{4cm}{\centering LOGO MISSING}}\end{center}
            }
        }
        \vspace{0.5cm} 
        
        % Title
        {\color{brandOrange} \fontsize{30}{75}\selectfont $title$ \par}
        
        % Subtitle
        $if(subtitle)$ \vspace{1.3cm} {\fontsize{24}{28}\selectfont $subtitle$ \par} $endif$
        
        \vfill 
        
        % Metadata Table
        % Dùng minipage để gói gọn bảng metadata và căn giữa nó
        \begin{minipage}{0.8\textwidth} 
            \centering % Căn giữa nội dung trong minipage (nếu cần) hoặc để raggedright
            \raggedright
            \renewcommand{\arraystretch}{1.5}
            \begin{tabular}{ll}
                \textbf{Security classification:} & \detokenize{$security$} \\
                \textbf{Document code:} & \detokenize{$doc_code$} \\
                \textbf{Last updated by:} & \detokenize{$updated_by$} \\
                \textbf{Effective date:} & \detokenize{$effective_date$} \\
                \textbf{Version:} & \detokenize{$version$} \\
                \textbf{Template ID:} & \detokenize{$template_id$} \\
            \end{tabular}
        \end{minipage}
        
        \restoregeometry
    \end{titlepage}
}

% =================================================================
% --- 10. DOCUMENT CONTENT --- [ĐÃ SỬA]
% =================================================================
\onehalfspacing
\begin{document}

\maketitle 
\clearpage 

% --- Document Control Table ---
\noindent\hspace{-\NumberWidth}%
{\color{brandOrange}\fontsize{15}{18}\selectfont\bfseries DOCUMENT CONTROL}%
\par\vspace{6pt}

$if(changelog)$
% Table này sẽ làm bộ đếm tăng lên 1
\begin{longtable}{|p{0.09\textwidth}|p{0.22\textwidth}|p{0.14\textwidth}|p{0.12\textwidth}|p{0.16\textwidth}|p{0.12\textwidth}|}
    \hline
    \rowcolor{brandOrange}
    \textbf{Version} & \textbf{Change Description} & \textbf{Changed By} & \textbf{Date} & \textbf{Approved By} & \textbf{Date} \\
    \hline
    $for(changelog)$
    $changelog.version$ & $changelog.description$ & $changelog.changed_by$ & $changelog.changed_date$ & $changelog.approved$ & $changelog.approval_date$ \\ \hline
    $endfor$
\end{longtable}
$endif$
\clearpage 

% --- TOC ---
\insertTOC  
\insertListTables  
\insertListFigures

% >>> QUAN TRỌNG: RESET BỘ ĐẾM TRƯỚC KHI VÀO NỘI DUNG CHÍNH <<<
% Đặt lại đếm bảng về 0 (để bảng tiếp theo sẽ là Table 1)
\setcounter{table}{0}
\setcounter{figure}{0}

% --- Main Body ---
$body$

\end{document}